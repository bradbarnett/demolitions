<!DOCTYPE html>
<html>
<head>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-67190694-1', 'auto');
    ga('send', 'pageview');

  </script>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css"/>
  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="foundation/css/foundation.css" />
  <link href='http://fonts.googleapis.com/css?family=Arvo' rel='stylesheet' type='text/css'>
<!--   <script src="js/date.js"></script>
 -->  <script src="js/vendor/modernizr.js"></script>
  <!-- <script src="mainscript.js"></script> -->
</head>

<body>
<script>
</script>
  <div class="fixed"> 
    <nav class="top-bar" data-topbar role="navigation">
      <div id="title">DisplaceMap: Demolitions in Seattle since 2010</div>   
      <div id="controls">
        <svg class="control" version="1.1" id="play" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
             viewBox="0 0 232.153 232.153" style="enable-background:new 0 0 232.153 232.153;" xml:space="preserve">
          <g id="Play">
            <path style="fill-rule:evenodd;clip-rule:evenodd;" d="M203.791,99.628L49.307,2.294c-4.567-2.719-10.238-2.266-14.521-2.266
              c-17.132,0-17.056,13.227-17.056,16.578v198.94c0,2.833-0.075,16.579,17.056,16.579c4.283,0,9.955,0.451,14.521-2.267
              l154.483-97.333c12.68-7.545,10.489-16.449,10.489-16.449S216.471,107.172,203.791,99.628z"/>
          </g>
        </svg>

        <svg class="control" version="1.1" id="pause" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 232.679 232.679" style="enable-background:new 0 0 232.679 232.679;" xml:space="preserve">
          <g id="Pause">
            <path style="fill-rule:evenodd;clip-rule:evenodd;" d="M80.543,0H35.797c-9.885,0-17.898,8.014-17.898,17.898v196.883
              c0,9.885,8.013,17.898,17.898,17.898h44.746c9.885,0,17.898-8.013,17.898-17.898V17.898C98.44,8.014,90.427,0,80.543,0z M196.882,0
              h-44.746c-9.886,0-17.899,8.014-17.899,17.898v196.883c0,9.885,8.013,17.898,17.899,17.898h44.746
              c9.885,0,17.898-8.013,17.898-17.898V17.898C214.781,8.014,206.767,0,196.882,0z"/>
          </g> 
        </svg>

        <svg class="control" version="1.1" id="replay" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
             viewBox="0 0 28.265 28.265" style="enable-background:new 0 0 28.265 28.265;" xml:space="preserve">
          <g>
            <path d="M14.133,28.265c-7.061,0-12.805-5.75-12.805-12.809c0-7.06,5.744-12.807,12.805-12.807c0.469,0,0.943,0.027,1.414,0.08
              v-2.07c0-0.266,0.164-0.508,0.406-0.611c0.252-0.098,0.531-0.043,0.723,0.148l4.537,4.547c0.258,0.258,0.258,0.67,0,0.932
              l-4.535,4.557c-0.193,0.188-0.473,0.246-0.725,0.143c-0.242-0.104-0.406-0.344-0.406-0.609V7.47
              c-0.469-0.086-0.941-0.125-1.414-0.125c-4.473,0-8.113,3.639-8.113,8.111c0,4.471,3.641,8.113,8.113,8.113s8.111-3.643,8.111-8.113
              c0-0.363,0.295-0.66,0.662-0.66h3.369c0.365,0,0.662,0.297,0.662,0.66C26.937,22.515,21.189,28.265,14.133,28.265z"/>
          </g>
        </svg>
      </div>
      <div id="timestamp"></div>
    </nav>
  </div>  
  
  <section>
    <div id="map" class="demolitions-map">
    </div>
  </section>


  <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.4"></script>
  <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
  <script src="js/L.Map.Sync.js"> </script>
  <script src="js/leaflet.label.js"></script>
  <script src="js/leaflet.label-src.js"></script>
  <script src="js/Leaflet.Coordinates-0.1.4.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script type="text/javascript" src="d3/d3.min.js"></script>
  <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.4"></script>
  <link rel="stylesheet" type="text/css" href="foundation/css/app.css">
    <script>
  
$(function() {



var mapDemolitions = new L.Map("map", {
  center: new L.LatLng(47.6163889,-122.328043),
  zoom: 14,
  zoomControl: true,
  opacity: 0.5, 
  attributionControl: true
});

var baseLayer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
  subdomains: 'abcd',
  maxZoom: 19
});

mapDemolitions.addLayer(baseLayer);


  mapDemolitions._initPathRoot();


var svg = d3.select(mapDemolitions.getPanes().overlayPane).append("svg"),
    g = svg.append("g").attr("class", "leaflet-zoom-hide");

d3.json("seattle-buildings-demolished.geojson", function(error, collection) {
  if (error) throw error;

  var transform = d3.geo.transform({point: projectPoint}),
      path = d3.geo.path().projection(transform);

  var feature = g.selectAll("path")
      .data(collection.features)
    .enter().append("path").attr("opacity",0).attr("stroke", "rgb(255, 124, 81)").attr("stroke-width",2).style("fill","rgb(255, 124, 81)");

  mapDemolitions.on("viewreset", reset);
  reset();

  // Reposition the SVG to cover the features.
  function reset() {
    var bounds = path.bounds(collection),
        topLeft = bounds[0],
        bottomRight = bounds[1];

    svg .attr("width", bottomRight[0] - topLeft[0])
        .attr("height", bottomRight[1] - topLeft[1])
        .style("left", topLeft[0] + "px")
        .style("top", topLeft[1] + "px");

    g   .attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

    feature.attr("d", path);
  }

  // Use Leaflet to implement a D3 geometric transformation.
  function projectPoint(x, y) {
    var point = mapDemolitions.latLngToLayerPoint(new L.LatLng(y, x));
    this.stream.point(point.x, point.y);
  }

    var time = 1262332800;
               // 1444953600
               // 1287532800
    var previousTime;
    var filtered = collection.features.filter(function(d){
      return (d.properties.UnixIssue < 1262332800);
    });



    function update(startTime) {
      if (startTime === undefined) {
        time = time;   
           
      }
      else
      {
         time = startTime; 
      }

      previousTime = time;    
      
      time = time + 1233280;
      showDateTime(time);
      filtered = feature.filter(function(d){ return (d.properties.UnixIssue < time);}).attr("class","selected");

      d3.selectAll(".selected").transition().duration(500).attr("opacity",1).each(slide);

      function slide() {
        var onePath = d3.select(this);
        (function repeat() {
          onePath = onePath
              .transition()
              .duration(350)
              .attr("stroke","white")
              .attr("stroke-width",20)
              .style("stroke-opacity",0)
              ;
              // .each("end", repeat);
        })();
      }

      console.log(time);
      console.log(filtered);

      var now = new Date();
      var startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      var timeStop = startOfDay / 1000;
      console.log(timeStop);

      if (time < timeStop) {
        timeOut = setTimeout(update,100); 
      }

      else return;         
     }

function showDateTime(time){
      var newDate = new Date();
      newDate.setTime(time*1000);
      dateString = newDate.toString();
      dateString = dateString.slice(0,16);
      document.getElementById("timestamp").innerHTML = dateString;
     }

d3.select("#play").on("click", function() {
  $("#play").toggle();
  $("#pause").toggle();
  update();
});

d3.select("#pause").on("click", function() {
    $("#play").toggle();
  $("#pause").toggle();
  clearTimeout(timeOut);
  console.log("stop");
});

d3.select("#replay").on("click", function() {
  clearTimeout(timeOut);
  $("#play").hide();
  $("#pause").show();
  update(1262332800);
  console.log("stop");
});

});




 });
</script>
<script src="js/foundation.min.js"></script>
<script>
  $(document).foundation();
  $(document).ready(function(){$('#myModal').foundation('reveal', 'open')}); 
</script> 
<script type="text/javascript" src="js/skrollr.min.js"></script>
<!-- <script type="text/javascript">
    $(".story").click(function() {
      var activeId = this.id;
      var section = $("section#" + activeId);
      var idOffset = $(section).offset();
      var idOffsetTop = idOffset.top - 35;
      console.log(idOffset.top);  
      $('html, body').animate({
        scrollTop: idOffsetTop}, 800, "easeInOutSine" );
      return false;
    });    
</script> -->
</body>
</html>
